<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Penilaian Esai</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìù Form Penilaian Esai</h1>
    <nav><a href="dashboard.html">‚¨ÖÔ∏è Kembali</a></nav>
    <div class="card" id="previewContainer"></div>

    <form id="evalForm">
      <h2>Rubrik Penilaian</h2>
      <div id="formFields"></div>
      <label>Komentar/Feedback:</label>
      <textarea id="comment" rows="3"></textarea>
      <button type="button" onclick="simpanPenilaian()">üíæ Simpan Penilaian</button>
    </form>
  </div>

  <img id="helpIcon" src="assets/ikonguide.png" onclick="openGuide()" alt="Petunjuk Penilaian">

  <div id="guideModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeGuide()">&times;</span>
      <div id="guideContent"></div>
      <div class="nav-buttons">
        <button onclick="prevPage()">‚¨ÖÔ∏è Back</button>
        <button onclick="nextPage()">Next ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div id="rpgDialog" class="dialog-box" style="display: none;">
    <h2>üéâ Good Job!</h2>
    <p>Lanjutkan anak muda..... !</p>
    <button onclick="closeDialog()">Lanjutkan</button>
  </div>

  <script src="data.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script>
    const essayId = localStorage.getItem("currentEssayId");
    const reviewerNRP = localStorage.getItem("reviewerNRP");
    if (!essayId || !reviewerNRP) location.href = "index.html";

    const essay = ESSAYS.find(e => e.id === essayId);
    if (!essay) location.href = "dashboard.html";

    document.getElementById("previewContainer").innerHTML = `
      <h2>${essay.title}</h2>
      <iframe src="${essay.gdrive}" width="100%" height="400" style="border:2px solid pink; border-radius:10px;"></iframe>
    `;

    const kriteria = [
      { key: "plagiarisme", label: "Plagiarisme dan AI (max 30% ‚Äî bobot 40)", max: 40 },
      { key: "judul", label: "Judul maksimal 20 kata (bobot 5)", max: 5 },
      { key: "kata", label: "Total kata 1000‚Äì2000 (bobot 5)", max: 5 },
      { key: "sitasi", label: "Kesesuaian sitasi dan daftar pustaka (bobot 10)", max: 10 },
      { key: "ejaan", label: "Ejaan dan tanda baca (bobot 8)", max: 8 },
      { key: "format", label: "Kesesuaian format dokumen (bobot 12)", max: 12 },
      { key: "sistematika", label: "Sistematika Esai (bobot 8)", max: 8 },
      { key: "data", label: "Penyajian data yang valid (bobot 10)", max: 10 }
    ];

    const saved = getEvaluation(essayId);
    const fieldContainer = document.getElementById("formFields");

    kriteria.forEach(item => {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = `
        <label>${item.label}</label>
        <input type="number" class="score-input" name="${item.key}" min="0" max="${item.max}" required
               value="${saved?.scores?.[item.key] || ''}">
      `;
      fieldContainer.appendChild(wrapper);
    });

    document.getElementById("comment").value = saved?.comment || "";

    function simpanPenilaian() {
      const scores = {};
      let valid = true;

      document.querySelectorAll('.score-input').forEach((input) => {
        const val = parseFloat(input.value);
        const max = parseFloat(input.max);
        if (isNaN(val) || val < 0 || val > max) {
          input.style.border = '2px solid red';
          valid = false;
        } else {
          input.style.border = '';
          scores[input.name] = val;
        }
      });

      const comment = document.getElementById("comment").value;

      if (!valid) {
        alert("Nilai harus valid dan sesuai rentang maksimum.");
        return;
      }

      if (!essayId) {
        alert("ID esai tidak ditemukan!");
        return;
      }

      saveEvaluation(essayId, scores, comment);
      firePixelConfetti();
      showDialog();
    }

    function firePixelConfetti() {
      confetti({
        particleCount: 80,
        angle: 90,
        spread: 90,
        origin: { y: 0.6 },
        colors: ['#ff69b4', '#ffc0cb', '#ff1493', '#ffe6eb'],
        shapes: ['square']
      });
    }

    function showDialog() {
      document.getElementById("rpgDialog").style.display = "block";
    }

    function closeDialog() {
      document.getElementById("rpgDialog").style.display = "none";
      window.location.href = "dashboard.html";
    }

    const guidePages = [
      `<h2>Rubrik Penilaian Esai</h2>
        <ul>
          <li>Plagiarisme & AI: max 40 poin</li>
          <li>Judul maksimal 20 kata: 5 poin</li>
          <li>Total kata 1000‚Äì2000: 5 poin</li>
          <li>Referensi/sitasi & daftar pustaka: 10 poin</li>
        </ul>`,
      `<h2>Rubrik Penilaian Esai (lanjutan)</h2>
        <ul>
          <li>Ejaan & Tanda Baca: 8 poin</li>
          <li>Format dokumen: 12 poin</li>
          <li>Sistematika esai: 8 poin</li>
          <li>Data valid & relevan: 10 poin</li>
        </ul>`,
      `<h2>Tips Penilaian Objektif</h2>
        <ul>
          <li>Perhatikan proporsi penilaian</li>
          <li>Bandingkan dengan rubrik secara konsisten</li>
          <li>Gunakan komentar untuk memperkuat penilaian</li>
        </ul>`
    ];

    let guideIndex = 0;

    function openGuide() {
      document.getElementById("guideModal").style.display = "block";
      showGuidePage();
    }

    function closeGuide() {
      document.getElementById("guideModal").style.display = "none";
    }

    function showGuidePage() {
      document.getElementById("guideContent").innerHTML = guidePages[guideIndex];
    }

    function nextPage() {
      if (guideIndex < guidePages.length - 1) {
        guideIndex++;
        showGuidePage();
      }
    }

    function prevPage() {
      if (guideIndex > 0) {
        guideIndex--;
        showGuidePage();
      }
    }

    // Efek klik
    const blip = new Howl({ src: ['assets/sfx/select.mp3'], volume: 0.9 });
    document.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => blip.play());
    });
  </script>
</body>
</html>
